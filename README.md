<h1 align="center"> HDPD: Hierarchical Decomposition of Performance Differences </h1>
<p align="center"> <b>A hierarchical decomposition for explaining ML performance discrepancies</b> (<a href="https://arxiv.org/pdf/2402.14254.pdf">Singh et al. 2024</a>). 
</p>

<p align="center">
  <img src="https://img.shields.io/badge/license-MIT-blue.svg">
  <img src="https://img.shields.io/badge/python-3.11+-blue">  
</p> 

<p align="center"> HDPD helps to explain why the performance of a machine learning model differs across environments. It presents variable importance plots of contributions from different types of distribution shifts in (groups of) features to model performance.
</p>

## Overview of repo
* Main file is [`src/get_shapley_estimate.py`](src/get_shapley_estimate.py) which computes the Shapley values-based variable importance measure.
* Estimators and inference procedures are implemented in [`src/estimate_datashifter.py`](src/estimate_datashifter.py).
* File [`src/comparators.py`](src/comparators.py) computes the comparator results.

## Installation instructions
Install required packages by running `pip install -r requirements.txt`

Simulation data is generated by the code itself.

To run case study for ACS Public Coverage task, run the Python notebook [`src/download_acs_data.ipynb`](src/download_acs_data.ipynb)
which downloads and preprocesses the ACS data using [folktables](https://github.com/socialfoundations/folktables) package. Please consult the terms of use and data sharing in the [folktables](https://github.com/socialfoundations/folktables?tab=readme-ov-file#license-and-terms-of-use) package.

Ensure following files are in the [`data`](data) folder 
1. `acs_pubcov_feature_names.csv`, `acs_pubcov_target.csv`, `acs_pubcov_source_val.csv`, `acs_pubcov_source_train.csv`

## Reproducing experiments
We run experiments using the `nestly` and `scons` framework.

To run an experiment, run `scons <FOLDER_NAME>` where `<FOLDER_NAME>` should contain the `sconscript` file specifying the experiment setup e.g. [`src/simulation/sconscript`](src/simulation/sconscript).

To run parallel processes on a cluster using qsub, run `scons <FOLDER_NAME> --cluster=cluster -j <NUM_PARALLEL>`.

Run following to reproduce figures.

1. To run simulations to check coverage in Section 5.1 Figure 3, run 
`scons simulation`
2. To run simulations to compare methods in Section 5.2 Figures 4a and 4b, run 
`scons simulation_comparators`
3. To run analysis for case study on ACS Public Coverage Figure 5b, run 
`scons casestudy`

### Contact
Please post in Issues here or email us if you have any questions:

* Harvineet Singh (harvineet1992@gmail.com)
* Jean Feng (jean.feng@ucsf.edu)

### Citation

```r
@inproceedings{singh2024a,
title={A hierarchical decomposition for explaining {ML} performance discrepancies},
author={Harvineet Singh and Fan Xia and Adarsh Subbaswamy and Alexej Gossmann and Jean Feng},
booktitle={The Thirty-eighth Annual Conference on Neural Information Processing Systems},
year={2024},
url={https://openreview.net/forum?id=nXXwYsARXB}
}
```
